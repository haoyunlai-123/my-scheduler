<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.my.scheduler.admin.repository.JobInstanceMapper">

    <resultMap id="JobInstanceMap" type="com.my.scheduler.admin.domain.JobInstance">
        <id column="id" property="id"/>
        <result column="job_id" property="jobId"/>
        <result column="trigger_time" property="triggerTime"/>
        <result column="executor_id" property="executorId"/>
        <result column="status" property="status"/>
        <result column="retry_count" property="retryCount"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="duration_ms" property="durationMs"/>
        <result column="last_error" property="lastError"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        insert into job_instance
        (job_id, trigger_time, executor_id, status, retry_count)
        values
        (#{jobId}, #{triggerTime}, #{executorId}, #{status}, #{retryCount})
    </insert>

    <select id="selectById" resultMap="JobInstanceMap">
        select * from job_instance where id = #{id}
    </select>

    <select id="selectByJobId" resultMap="JobInstanceMap">
        select * from job_instance
        where job_id = #{jobId}
        order by id desc
        limit #{limit}
    </select>

    <select id="selectWaitingForDispatch" resultMap="JobInstanceMap">
        select * from job_instance
        where status = 'WAITING'
        order by id asc
        limit #{limit}
    </select>

    <!-- 乐观更新：只有 WAITING 才能标 RUNNING，避免重复派发 -->
    <update id="markRunning">
        update job_instance
        set status = 'RUNNING',
        executor_id = #{executorId},
        start_time = #{startTime}
        where id = #{id}
        and status = 'WAITING'
    </update>

    <update id="markFinished">
        update job_instance
        set status = #{status},
        end_time = #{endTime},
        duration_ms = #{durationMs},
        last_error = #{lastError}
        where id = #{id}
    </update>

    <!-- 只有当前 executor_id 匹配且 RUNNING 才能退回 WAITING，避免乱改 -->
    <update id="markWaitingFromRunning">
        update job_instance
        set status = 'WAITING',
        executor_id = null,
        start_time = null
        where id = #{id}
        and status = 'RUNNING'
        and executor_id = #{executorId}
    </update>

</mapper>
