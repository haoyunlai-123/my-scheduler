<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.my.scheduler.admin.repository.JobInstanceMapper">

    <resultMap id="JobInstanceMap" type="com.my.scheduler.admin.domain.JobInstance">
        <id column="id" property="id"/>
        <result column="job_id" property="jobId"/>
        <result column="trigger_time" property="triggerTime"/>
        <result column="executor_id" property="executorId"/>
        <result column="status" property="status"/>
        <result column="retry_count" property="retryCount"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="duration_ms" property="durationMs"/>
        <result column="last_error" property="lastError"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        insert into job_instance
        (job_id, trigger_time, executor_id, status, retry_count)
        values
        (#{jobId}, #{triggerTime}, #{executorId}, #{status}, #{retryCount})
    </insert>

    <select id="selectById" resultMap="JobInstanceMap">
        select * from job_instance where id = #{id}
    </select>

    <select id="selectByJobId" resultMap="JobInstanceMap">
        select * from job_instance
        where job_id = #{jobId}
        order by id desc
        limit #{limit}
    </select>

    <select id="selectWaitingForDispatch" resultMap="JobInstanceMap">
        select * from job_instance
        where status = 'WAITING'
        order by id asc
        limit #{limit}
    </select>

    <!-- 乐观更新：只有 WAITING 才能标 RUNNING，避免重复派发 -->
    <update id="markRunning">
        update job_instance
        set status = 'RUNNING',
        executor_id = #{executorId},
        start_time = #{startTime}
        where id = #{id}
        and status = 'WAITING'
    </update>

    <update id="markFinished">
        update job_instance
        set status = #{status},
        end_time = #{endTime},
        duration_ms = #{durationMs},
        last_error = #{lastError}
        where id = #{id}
        and status = 'RUNNING'
    </update>

    <!-- 只有当前 executor_id 匹配且 RUNNING 才能退回 WAITING，避免乱改 -->
    <update id="markWaitingFromRunning">
        update job_instance
        set status = 'WAITING',
        executor_id = null,
        start_time = null
        where id = #{id}
        and status = 'RUNNING'
        and executor_id = #{executorId}
    </update>

    <select id="selectRunningTimeout" resultMap="JobInstanceMap">
        <![CDATA[
        select ji.*
        from job_instance ji
        join job j on ji.job_id = j.id
        where ji.status = 'RUNNING'
        and ji.start_time is not null
        and date_add(ji.start_time, interval j.timeout_ms/1000 second) <= #{now}
        order by ji.start_time asc
        limit #{limit}
        ]]>
    </select>

    <update id="markTimeout">
        update job_instance
        set status = 'TIMEOUT',
        end_time = #{endTime},
        duration_ms = #{durationMs},
        last_error = #{lastError}
        where id = #{id}
        and status = 'RUNNING'
    </update>

    <select id="selectRetryable" resultMap="JobInstanceMap">
        <![CDATA[
        select ji.*
        from job_instance ji
        join job j on ji.job_id = j.id
        where ji.status in ('FAILED','TIMEOUT')
        and ji.retry_count < j.retry_max
                             order by ji.id asc
                             limit #{limit}
        ]]>
    </select>

    <update id="backToWaitingForRetry">
        <![CDATA[
        update job_instance ji
        join job j on ji.job_id = j.id
        set ji.status = 'WAITING',
        ji.executor_id = null,
        ji.start_time = null,
        ji.end_time = null,
        ji.duration_ms = null,
        ji.last_error = null,
        ji.retry_count = ji.retry_count + 1
        where ji.id = #{id}
        and ji.status in ('FAILED','TIMEOUT')
        and ji.retry_count < j.retry_max
        ]]>
    </update>


</mapper>
